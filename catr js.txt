const tableBody = document.querySelector('.tableBody')
const emailValue = sessionStorage.getItem('emailVal')
window.addEventListener('DOMContentLoaded', async()=>{
    const data = await axios.get('/data/cart')
    const usersCart = data.data.map(cart=>{
        if(cart.email === emailValue){
            return `
            <tr>
            <td class="image-holder"><img src="${cart.image}" class="imgFood" alt="food image" style="width: 70px; height:60px;"></td>
            <td class="magac">${cart.magacCuntada}</td>
            <td class="pp">${"$" + cart.qiimahaSheygiiba}</td>
            <td class="" ><input class="quantity" type="number" class="form-control" style="width: 50px; "></td>
            <td ><button class="btn btn-danger deleteRow">Remove</button></td>
            
        </tr>`
        }
    }).join('')
   
    tableBody.innerHTML = usersCart
    // updateCartTotal()
    inputM()
    removeButtons()
})
function quantityChanged(event){
    let input = event.target
   if(isNaN(input.value) || input.value<=0){
       input.value = 1
   }
   updateCartTotal()
}
function inputM(){
    let quantityInputs = document.getElementsByClassName('quantity')
    for (var i = 0; i < quantityInputs.length; i++) {
        var input = quantityInputs[i]
        input.addEventListener('change', quantityChanged)
    }

}

async function removeCartItem(event){
    let buttonClicked = event.target
    const rowOrder = buttonClicked.parentElement.parentElement
    const foodName = rowOrder.getElementsByClassName('magac')[0].innerText
    setTimeout(async()=>{
        const data = await axios.patch('/api/remove/order', {foodName:foodName})
        
    }, 10)
    console.log('hello')
    buttonClicked.parentElement.parentElement.remove()
    updateCartTotal()
}
function removeButtons(){
    let dangerButtons =  document.querySelectorAll('.deleteRow')
    for(let i = 0; i< dangerButtons.length; i++){
        let button = dangerButtons[i]
        button.addEventListener('click', removeCartItem)
         }

}


function updateCartTotal(){
    const cartRows = tableBody.getElementsByTagName('tr')
    let total = 0
    for(let i = 0; i< cartRows.length; i++){
        let row = cartRows[i]
        const pricePerItem = parseFloat(row.getElementsByClassName('pp')[0].innerText.replace('$', ''))
        const quantity = row.getElementsByClassName('quantity')[0].value
        // console.log(quantity)
       total = total + (pricePerItem * quantity)

    //    total = Math.round(total * 100)/100
       document.querySelector('.totalMoney').innerText = "$" + total
        
    }
}

const sendOrder = document.querySelector('.sendOrder')
sendOrder.addEventListener('click', async()=>{
    const tRow = tableBody.getElementsByTagName('tr')
    for(let i = 0; i<tRow.length; i++){
        const row = tRow[i]
        const imageHolder = row.getElementsByClassName('image-holder')[0]
        const imageItem = imageHolder.getElementsByClassName('imgFood')[0].src
        const magac = row.getElementsByClassName('magac')[0].innerText
        const pp = row.getElementsByClassName('pp')[0].innerText.replace('$', '')
        const quantity = row.getElementsByClassName('quantity')[0].value
        const totalP = Number(document.getElementsByClassName('totalMoney')[0].innerText.replace('$', ''))
        // console.log(imageItem, magac, pp, quantity)
       
        if(totalP >0){
            const alertPart = document.getElementsByClassName('alertPart')[0]
            const fullName = document.getElementsByClassName('fullName')[0].value
            console.log(fullName)
            if(fullName !==''){
                setTimeout(async()=>{
                    await axios.post('/api/realOrder', {imageItem:imageItem, magac:magac, pp:pp, quantity:quantity, fullName:fullName})
                    
                }, 10)

                tableBody.innerText =  ''
       
                document.getElementsByClassName('totalMoney')[0].innerText = "$" + 0
                // console.log(sessionStorage.getItem('emailVal'))
                let logedUser = sessionStorage.getItem('emailVal')
                setTimeout(async()=>{
                    await axios.patch('/delete/fullfilled/order', {logedUser:logedUser})
       
                }, 10)
                alertPart.innerHTML = `
                <div class="alert alert-success alert-dismissible">
           <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
           <strong>GULL!</strong>macamiil waxaan kuugu adeegi doonnaa sida ugu dhaqsiyaha badan.
         </div>`
            }else{
                alertPart.innerHTML = `
                <div class="alert alert-danger alert-dismissible">
           <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
           <strong>GULL!</strong>WAALAAL GALI MAGACAGA OO DHAMEYSTIRAN.
         </div>`
            }
        }
    }
})


